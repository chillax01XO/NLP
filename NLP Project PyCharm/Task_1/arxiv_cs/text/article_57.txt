arXiv:2505.21182v1  [cs.LG]  27 May 2025Learning What to Do and What Not To Do: Offline
Imitation from Expert and Undesirable
Demonstrations
Huy Hoang
Singapore Management University
mh.hoang.2024@phdcs.smu.edu.sgTien Mai
Singapore Management University
atmai@smu.edu.sg
Pradeep Varakantham
Singapore Management University
pradeepv@smu.edu.sgTanvi Verma
Institute of High Performance Computing
Agency for Science, Technology and Research, Singapore
Tanvi_Verma@ihpc.a-star.edu.sg
Abstract
Offline imitation learning typically learns from expert and unlabeled demonstra-
tions, yet often overlooks the valuable signal in explicitly undesirable behaviors. In
this work, we study offline imitation learning from contrasting behaviors, where the
dataset contains both expert and undesirable demonstrations. We propose a novel
formulation that optimizes a difference of KL divergences over the state-action vis-
itation distributions of expert and undesirable (or bad) data. Although the resulting
objective is a DC (Difference-of-Convex) program, we prove that it becomes convex
when expert demonstrations outweigh undesirable demonstrations, enabling a prac-
tical and stable non-adversarial training objective. Our method avoids adversarial
training and handles both positive and negative demonstrations in a unified frame-
work. Extensive experiments on standard offline imitation learning benchmarks
demonstrate that our approach consistently outperforms state-of-the-art baselines.
1 Introduction
Imitation learning [ 8,21,25,15,40] offers a compelling alternative to Reinforcement Learning
(RL) [ 37,32,29] by enabling agents to learn directly from expert demonstrations without the need
for explicit reward signals. This paradigm has been successfully applied in various domains, even
with limited expert data, and is particularly effective in capturing complex human behaviors and
preferences.
Traditional imitation learning typically assumes access to high-quality expert demonstrations, which
can be expensive and difficult to obtain [ 34,38,44]. In practice, datasets often contain a mixture of
expert and sub-optimal demonstrations. Recent advances in imitation learning have begun to address
this more realistic setting, aiming to develop algorithms that can leverage informative signals from
both expert and non-expert data [4, 30, 15].
While existing imitation learning approaches in the mixed-quality setting typically assume that mixed-
quality demonstrations are not drastically different from expert behavior, they often frame learning
as mimicking both expert and sub-optimal trajectoriesâ€”albeit with different weights [ 21,20,40].
However, in practice, mixed-quality data may contain poor or undesirable demonstrations that the
agent should explicitly avoid. For example, in autonomous driving, undesirable demonstrations
may include unsafe lane changes or traffic violations, which should not be imitated under any
circumstances. Another example can be found in healthcare applications, where undesirable demon-
Preprint. Under review.strations may correspond to incorrect diagnoses or unsafe treatment plans that could harm patients
if imitated. Existing imitation learning approaches are limited in their ability to handle contrasting
demonstrations. Most methods are either not explicitly designed to avoid undesirable behaviors, or
are ill-equipped to deal with scenarios where both expert and undesirable demonstrations coexist
within the dataset [ 39,42,15]. It is important to note that learning by mimicking expert or mildly
sup-optimal demonstrations is often tractable, as the corresponding objectiveâ€”typically framed
as divergence minimizationâ€”is convex [ 21,20]. However, incorporating objectives that explicitly
avoid bad (or undesirable) demonstrations can introduce non-convexities, making the optimization
significantly more challenging. In this paper, we propose a unified framework that addresses these
challenges, aiming to bridge this gap in the current imitation learning literature.
Specifically, we focus on the setting of offline imitation learning , where interaction with the environ-
ment is not available, and assume that the dataset contains both expert andundesirable demonstrations.
We make the following contributions:
â€¢We formulate the learning problem with the goal of matching expert behavior while explicitly
avoiding undesirable demonstrations. Although the resulting training objective is expressed
as the difference between two KL divergences (and is therefore difference-convex), we
prove that it becomes convex when the expert component outweighs the undesirable one.
This convexity is critical, as it enables us to reformulate the learning problem over the
state-action visitation distribution as an more tractable unconstrained optimization via
Lagrangian duality. Our objective stands in contrast to most existing distribution-matching
imitation learning approaches, which typically rely solely on divergence minimization and
naturally yield convex objectives. By introducing a divergence maximization term to account
for undesirable behavior, we demonstrate that the overall objective remains convex and
manageable.
â€¢We further enhance the learning objective by proposing a surrogate objective that lower-
bounds the original one, offering the advantage of a non-adversarial and convex optimization
problem in the Q-function space. In addition, we introduce a novel Q-weighted behavior
cloning (BC) approach, supported by theoretical guarantees, for efficient policy extraction.
â€¢Extensive experiments on standard imitation learning benchmarks show that our method
consistently outperforms existing approaches, both in conventional settings where datasets
contain expert and unlabeled demonstrations, and in more realistic scenarios where explicitly
undesirable demonstrations are included.
2 Related Works
Imitation Learning. Imitation learning trains agents to mimic expert behavior from demonstrations,
with Behavioral Cloning (BC) serving as a foundational method by maximizing the likelihood of
expert actions. However, BC often suffers from distributional shift [ 34]. Recent work addresses
this issue by leveraging the strong generalization capabilities of generative models [ 43,5]. Inspired
by GANs [ 11], methods like GAIL [ 14] and AIRL [ 7] use a discriminator to align the learnerâ€™s
policy with the expertâ€™s, while SQIL [ 33] simplifies reward assignment by distinguishing expert
and non-expert behaviors. Although effective, these approaches typically require online interaction,
which may be impractical in many real-world scenarios.
To address this, offline methods such as AlgaeDICE [ 31] and ValueDICE [ 22] employ Stationary
Distribution Correction Estimation (DICE), though they often encounter stability issues. Building
on ValueDICE, O-NAIL [ 3] avoids adversarial training, enabling stable offline imitation. More
recently, several approaches have extended the DICE framework with stronger theoretical foundations
and improved empirical performance [ 24,28]. In parallel, IQ-Learn [ 8] has emerged as a unified
framework for both online and offline imitation learning, inspiring a range of follow-up works [ 2,16].
However, all these approaches rely on the presence of many expert demonstrations, which may not
always be available.
Offline imitation learning from suboptimal demonstrations: Several approaches have been
developed to tackle the challenges of offline imitation learning from suboptimal data, which is
common in real-world scenarios. A notable direction involves preference-based methods, where
algorithms infer reward functions by leveraging ranked or pairwise-compared trajectories to guide
learning [ 19,18,13]. Recent works, such as SPRINQL [ 15], take advantage of demonstrations
2that exhibit varying levels of suboptimality, enabling the learner to better generalize beyond near-
optimal behaviors. Another important line of research explores the use of unlabeled demonstrations
in conjunction with a limited number of expert trajectories. Techniques like DemoDICE [ 21],
SMODICE [ 27], and ReCOIL [ 35] apply Distribution Correction Estimation (DICE) [ 36,24,28] to re-
weight trajectories and align the state or state-action distributions with those of the expert. In parallel,
classifier-based methods, such as DWBC [ 40], ISW-BC [ 25], and ILID [ 41], use discriminators
to distinguish expert-like behaviors within mixed-quality data and assign them greater importance.
Collectively, these strategies aim to enhance policy robustness and performance in offline settings
where high-quality expert data is scarce or expensive to obtain. However, all of these approaches are
primarily focused on imitating and are unable to avoid undesirable or bad demonstrations, which is
crucial in domains such as self driving where there are many unsafe behaviors that would need to be
avoided.
SafeDICE [ 17] was introduced to address this problem of avoiding undesirable or bad demonstrations.
However, SafeDICE is not designed to handle scenarios where both expert and undesirable datasets
are available. Moreover, their approach still relies on minimizing a divergence between the learning
policy and a mixture of unlabeled and undesirable dataâ€”an approach that is vulnerable to the quality
of the unlabeled dataset and may degrade when such data is of low quality.
In this paper, we aim to optimize on the principle of "Imitate the Good and Avoid the Bad", which has
recently gained attention in reference and safe reinforcement learning [ 1,15,10] and large language
model training [ 26]. We extend this idea to the offline imitation setting by proposing a novel and
efficient method that learns from expert demonstrations while avoiding undesirable ones. To our
knowledge, this is the first offline imitation learning approach to efficiently learn policies by jointly
utilizing both expert and undesirable demonstrations.
3 Preliminaries
Markov Decision Process (MDP). We consider a MDP defined by the following tuple M=
âŸ¨S, A, r, P, Î³, s 0âŸ©, where Sdenotes the set of states, s0represents the initial state set, Ais the set of
actions, r:SÃ—Aâ†’Rdefines the reward function for each state-action pair, and P:SÃ—Aâ†’Sis
the transition function, i.e., P(sâ€²|s, a)is the probability of reaching state sâ€²âˆˆSwhen action aâˆˆA
is made at state sâˆˆS, andÎ³is the discount factor. In reinforcement learning (RL), the aim is to find
a policy that maximizes the expected long-term accumulated reward: max Ï€
E(s,a)âˆ¼dÏ€[r(s, a)]	
,
where dÏ€is the occupancy measure (or state-action visitation distribution) of policy Ï€:dÏ€(s, a) =
(1âˆ’Î³)Ï€(a|s)Pâˆž
t=1Î³tP(st=s|Ï€).
Offline Imitation Leaning. Recent imitation learning (IL) approaches have adopted a distribution-
matching formulation, where the objective is to minimize the divergence between the occupancy
measures (i.e., state-action visitation distributions) of the learning policy and the expert pol-
icy:mindÏ€
Df 
dÏ€âˆ¥dE	
,where Dfdenotes an f-divergence between the occupancy distri-
butions dÏ€(induced by the learning policy Ï€) and dE(induced by the expert policy). In par-
ticular, when the Kullbackâ€“Leibler (KL) divergence is used, the learning objective becomes:
mindÏ€E(s,a)âˆ¼dÏ€h
log
dÏ€(s,a)
dE(s,a)i
.In the space of state-action visitation distributions ( dÏ€), the
training can be formulated as a convex constrained optimization problem. To enable efficient training,
Lagrangian duality is typically employed to recast the problem into an unconstrained form [24, 21].
Offline IL with unlabeled data. In offline imitation learning with unlabeled data, it is
typically assumed that a limited set of expert demonstrations BEis available, along with
a larger set of unlabeled demonstrations BMIX. Distribution-matching approaches have been
widely adopted to handle this setting. Prior methods often formulate the objective as a
weighted sum of divergences between the learning policy and both expert and unlabeled data:
mindÏ€
Df 
dÏ€âˆ¥dE
+Î±Df(dÏ€âˆ¥dMIX)	
,where Î±â‰¥0.Other approaches construct mixtures of
occupancy distributions, such as dÏ€,MIX=Î±dÏ€+ (1âˆ’Î±)dMIXanddE,MIX=Î±dE+ (1âˆ’Î±)dMIX,and
minimize the divergence between dÏ€,MIXanddE,MIX[21,20,27,35]. In most existing approaches
along this line of research, the convexity of the objective with respect to dÏ€has been heavily leveraged
to derive tractable learning objectives. However, when a divergence maximization term is intro-
3ducedâ€”as in our approachâ€”this convexity may no longer hold, rendering many existing methods
inapplicable.
4 ContraDICE: Offline Imitation Learning from Contrasting Behaviors
We begin by introducing a novel learning objective based on the difference between two KL di-
vergences. Leveraging the convexity of this formulation, we derive a tractable and unconstrained
optimization problem. Given that the resulting objective includes exponential terms that may lead to
numerical instability, we enhance this by proposing a lower-bound approximation. This approxima-
tion enables us to reformulate the learning process as a more tractable, non-adversarial Q-learning
objective, which remains convex in the space of Q-functions.
4.1 Dual KL-Based Formulation
Assume that we have access to three sets of demonstrations: good dataset BGcontains good orexpert
demonstrations, bad dataset BBcontains badorundesirable demonstrations that the agent should
avoid, and the unlabeled dataset BMIXis a large set of unlabeled demonstrations used to support offline
training. We consider the realistic scenario where the identified datasets BGandBBare limited in
size, while BMIXis significantly largerâ€”an assumption that aligns with typical settings in offline
imitation learning from unlabeled demonstrations.
LetdÏ€(s, a),dG(s, a), and dB(s, a)denote the state-action visitation distributions induced by the
learned policy Ï€, the good policy, and the bad policy, respectively. Following the DICE framework [ 31,
22], we propose to optimize the following training objective:
min
dÏ€f(dÏ€) =DKL(dÏ€âˆ¥dG)âˆ’Î± D KL(dÏ€âˆ¥dB), (1)
where Î± >0is a tunable hyperparameter. The goal of this objective is twofold: (1) to minimize the
divergence between the learned policy and the good policy, and (2) to maximize the divergence from
the bad policy, thereby avoiding undesirable behavior.
This formulation differs from all existing DICE-based approaches in the literature, which primarily
focus on minimizing KL divergenceâ€”even when dealing with undesirable or unsafe demonstrations.
By contrast, our approach introduces a principled mechanism to explicitly repel the learned policy
from undesirable behavior while still aligning it with good data.
While the presence of a KL divergence maximization term in the objective may raise concerns
about the convexity of the training problem, we observe that the objective in (1)takes the form of a
difference between two convex functions. This is, in general, not convex and can be challenging to
optimize. Fortunately, we show that under a mild condition, the overall objective remains convex.
Specifically, if the weight on the bad policy divergence term is smaller than that on the good policy
(i.e.,Î± <1), then the objective becomes convex in dÏ€.
Proposition 4.1. IfÎ±â‰¤1, then the objective function f(dÏ€) =DKL(dÏ€âˆ¥dG)âˆ’Î± D KL(dÏ€âˆ¥dB)is
convex in dÏ€.
Convexity is essential in most DICE-based frameworks, as it enables the use of Lagrangian duality to
construct well-behaved and tractable training objectives. Our goal is to develop a Q-learning method
that recovers a policy minimizing the objective in (1). To this end, we formulate the problem as the
following constrained optimization:
min
d,Ï€f(d, Ï€) =DKL(dâˆ¥dG)âˆ’Î± D KL(dâˆ¥dB) (2)
s.t.d(s, a) = (1 âˆ’Î³)p0(s)Ï€(a|s) +Î³Ï€(a|s)X
sâ€²,aâ€²d(sâ€², aâ€²)T(s|sâ€², aâ€²),
where d(s, a)is the state-action visitation distribution, and Tis the environment transition function.
LetBU=BGâˆª BMIXdenote the union dataset, and let dUbe the state-action visitation distribution
derived from it. The following proposition gives an another formulation for the objective in (1):
Proposition 4.2. The objective function in (2)can be written as: f(d, Ï€) = (1 âˆ’Î±)DKL(d||dU)âˆ’
E(s,a)âˆ¼d[Î¨(s, a)], where Î¨(s, a) = logdG(s,a)
dU(s,a)âˆ’Î±logdB(s,a)
dU(s,a).
4This formulation introduces a KL-based regularization centered on the reference distribution dU,
withÎ¨(s, a)acting as a correction term that incorporates information from the labeled good and
bad demonstrations. The reformulated objective in Proposition 4.2 further confirms that the function
f(d, Ï€)remains convex in dwhen Î±â‰¤1. Here we note that, under the same condition Î±â‰¤1,
convexity may not hold for other f-divergences (a detailed discussion is provided in the appendix).
Given the convexity of the objective in (1), we can equivalently move the constraints into the objective
using Lagrangian duality, leading to the following Q-learning formulation (details of the derivation
are given in the appendix):
max
Ï€min
Qn
(1âˆ’Î³)E(s,a)âˆ¼p0,Ï€[Q(s, a)]
+ (1âˆ’Î±)E(s,a)âˆ¼dU
expÎ¨(s, a) +Î³E(sâ€²,aâ€²)âˆ¼T,Ï€[Q(sâ€², aâ€²)]âˆ’Q(s, a)
1âˆ’Î±o
To further enhance the efficiency of Q-learning, we adopt the well-known Maximum Entropy
(MaxEnt) reinforcement learning framework by incorporating an entropy term into the training
objective [8, 12]. This leads to the following objective:
L(Q, Ï€) = (1 âˆ’Î³)E(s,a)âˆ¼p0,Ï€
Q(s, a)âˆ’Î²logÏ€(a|s)
ÂµU(a|s)
+ (1âˆ’Î±)E(s,a)âˆ¼dUï£®
ï£°expï£«
ï£­Î¨(s, a) +Î³E(sâ€²,aâ€²)âˆ¼T,Ï€h
Q(sâ€², aâ€²)âˆ’Î²logÏ€(aâ€²|sâ€²)
ÂµU(aâ€²|sâ€²)i
âˆ’Q(s, a)
1âˆ’Î±ï£¶
ï£¸ï£¹
ï£».
where ÂµU(a|s)is the behavior policy representing the union dataset BU. We now define the soft
value function and the soft Bellman operator as follows:
VÏ€
Q(s) =Eaâˆ¼Ï€(Â·|s)
Q(s, a)âˆ’Î²logÏ€(a|s)
ÂµU(a|s)
,TÏ€[Q](s, a) =Q(s, a)âˆ’Î³Esâ€²âˆ¼T(Â·|s,a)
VÏ€
Q(sâ€²)
.
Using these definitions, the training objective can be rewritten as:
L(Q, Ï€) = (1 âˆ’Î³)Esâˆ¼p0
VÏ€
Q(s)
+ (1âˆ’Î±)E(s,a)âˆ¼dU
expÎ¨(s, a)âˆ’ TÏ€[Q](s, a)
1âˆ’Î±
.(3)
This formulation shares structural similarities with IQ-Learn, where TÏ€[Q](s, a)is referred to as
theinverse Bellman operator and is often interpreted as a reward function expressed in terms of the
Q-function itself.
Remark. The objective in Equation (3)is valid only when Î± < 1. In the special case where
Î±= 1, i.e., when the bad demonstrations are weighted equally to the expert demonstrationsâ€”the
training objective simplifies significantly. According to Proposition 4.2, the training objective
reduces to a standard offline RL problem with reward function Î¨(s, a):max dE(s,a)âˆ¼d[Î¨(s, a)] =
maxE[Pâˆž
t=0Î³tÎ¨(st, at)].
4.2 Tractable Lower Bounded Objective
In this section, we propose an additional step to improve the stability and tractability of the learning
objective introduced above. We first observe that the exponential term in Equation (3)may lead to
instability during training. To address this issue, we propose to approximate the exponential using
a linear lower bound, which not only improves stability but also preserves a similar optimization
objective.
Proposition 4.3. Let the surrogate objective be defined as:
eL(Q, Ï€) = (1 âˆ’Î³)Esâˆ¼p0
VÏ€
Q(s)
âˆ’EdU[Î´(s, a)TÏ€[Q](s, a)] + (1 âˆ’Î±)EdU[Î´(s, a)].(4)
where Î´(s, a) = exp
Î¨(s,a)
1âˆ’Î±
.TheneL(Q, Ï€)is a lower bound of L(Q, Ï€), with equality when
TÏ€[Q](s, a) = 0 for all (s, a).
5The lower-bound approximation eL(Q, Ï€)offers several benefits. First, as a valid lower bound of
L(Q, Ï€), maximizing eL(Q, Ï€)promotes the original objective. Second, its structureâ€”linear in Q
and concave in Ï€â€”leads to a simplified, non-adversarial training procedure (see Proposition 4.4).
Finally, its optimization goals remain aligned with those of L(Q, Ï€), encouraging high expected soft
value under the initial state distribution and consistency between the soft Bellman residual and the
guidance signal Î¨(s, a).
Remark. We note that the training objective in Equation (4)generalizes the IQ-Learn objective [ 8]
as a special case. In particular, eL(Q, Ï€)reduces exactly to the IQ-Learn objective when Î±= 0(i.e.,
the undesirable dataset is ignored) and BGâ‰¡ BU(i.e., the good dataset coincides with the union
dataset). To see this, observe that when Î±= 0 anddG=dU, the term Î¨(s, a)becomes zero for
all(s, a). As a result, the surrogate objective simplifies to: eL(Q, Ï€) = (1 âˆ’Î³)Esâˆ¼p0
VÏ€
Q(s)
âˆ’
E(s,a)âˆ¼dG[TÏ€[Q](s, a)],which is exactly the training objective proposed in IQ-Learn. Thus, our
formulation can be viewed as a principled extension of IQ-Learn that explicitly accounts for and
contrasts between good and bad behaviors.
We now present several key properties of the training objective eL(Q, Ï€)that make it particularly
convenient and tractable for use, as formalized in Proposition 4.4 below.
Proposition 4.4. The following properties hold:
(i)eL(Q, Ï€)is linear in Qand concave in Ï€. As a result, the maxâ€“min optimization can be equiv-
alently reformulated as a minâ€“max problem: max Ï€minQeL(Q, Ï€) = min Qmax Ï€eL(Q, Ï€).
(ii)The minâ€“max problem minQmax Ï€eL(Q, Ï€)reduces to the following non-adversarial prob-
lem:
min
Q
eL(Q) = (1 âˆ’Î³)Esâˆ¼p0[VQ(s)]âˆ’E(s,a)âˆ¼dU
expÎ¨(s, a)
1âˆ’Î±
T[Q](s, a)
,
where the soft value function VQ(s)is defined as: VQ(s) =
Î²log P
aÂµU(a|s) exp( Q(s, a)/Î²)
,and the soft Bellman residual operator is given by:
T[Q](s, a) =Q(s, a)âˆ’Î³VQ(s).Moreover eL(Q)is convex in Q.
5 Practical Algorithm
Estimating Occupancy Ratios. The training objective involves several ratios between state-action
visitation distributions, which are not directly observable. These quantities can be estimated by
solving corresponding discriminator problems. Specifically, to estimate the ratiodG(s,a)
dU(s,a), we train a
binary classifier cG:S Ã— A â†’ [0,1]by solving the following standard logistic regression objective:
max
cG
E(s,a)âˆ¼dG
logcG(s, a)
+E(s,a)âˆ¼dU
log(1âˆ’cG(s, a))	
. (5)
LetcGâˆ—(s, a)be optimal solution to this problem, then the ratio can be computed as:dG(s,a)
dU(s,a)=
cGâˆ—(s,a)
1âˆ’cGâˆ—(s,a).Similar discriminators can be trained to estimate other ratios such asdB(s,a)
dU(s,a).
Implicit V-Update and Regularizers. In the surrogate objective eL(Q), the value function VQis
typically computed via a log-sum-exp over Q, which becomes intractable in large or continuous action
spaces. To address this, we adopt Extreme Q-Learning (XQL) [ 9], which avoids the log-sum-exp by
introducing an auxiliary optimization over V, jointly updated with Q. Specifically, Vis optimized
using the Extreme-V objective: J(V|Q) =E(s,a)âˆ¼dU
et(s,a)âˆ’t(s, a)âˆ’1
,where t(s, a) =
Q(s,a)âˆ’V(s)
Î².The main training objective with fixed Vis:
eL(Q|V) = (1 âˆ’Î³)Esâˆ¼p0[V(s)]âˆ’E(s,a)âˆ¼dU
expÎ¨(s, a)
1âˆ’Î±
(Q(s, a)âˆ’Î³Esâ€²[V(sâ€²)])
.(6)
The overall optimization proceeds by alternating: (i) updating Qvia minimizing eL(Q|V), and (ii)
updating Vvia minimizing J(V|Q). Both sub-problems are convex, enabling efficient and stable
6training. To further enhance stability, we follow [ 8,9] and add a convex regularizer Ï•(T[Q](s, a))to
prevent reward divergence. We use the Ï‡2-divergence, Ï•(t) =t2/2, a common choice in Q-learning.
Policy Extraction Once the QandVfunctions are obtained, a common approach for expert policy
extraction is to apply advantage-weighted behavior cloning (AW-BC) [23, 9, 13, 35]:
max
Ï€X
(s,a)âˆ¼BUexp1
Î²(Q(s, a)âˆ’V(s))
logÏ€(a|s). (7)
A key limitation of this formulation is that the value function V(s)is only an approximate estimate
from the Extreme-V objective, potentially introducing noise and bias into advantage computation and
degrading policy quality. To address this, we propose a Q-only alternative that avoids reliance on
V(s). The following proposition shows that this Q-based objective can, in theory, recover the same
optimal policy as the original advantage-weighted BC formulation.
Proposition 5.1. The following Q-weighted behavior cloning (BC) objective yields the same optimal
policy as the original advantage-weighted BC formulation in (7):
max
Ï€X
(s,a)âˆ¼BUexp1
Î²Q(s, a)
logÏ€(a|s). (8)
Algorithm 1 ContraDICE
Require: Datasets BG,BB,BMIX; training steps NÂµ,N;
models: cG
wG,cB
wB,Ï€Î¸,Qwq,Vwv
1:Assign BU=BGâˆª BMIX
2:#Train discriminator cG
wGandcB
wB
3:fori= 1toNÂµdo
4: Update (wG, wB)to minimize Objective 5.
5:end for
6:#Train QwqandVwv, and policy Ï€Î¸
7:fori= 1toNdo
8: Update wqto minimize eF(Qwq|Vwv)
9: Update wvto minimize J(Vwv|Qwq)
10: Update Î¸via QW-BC:
max Ï€nP
(s,a)âˆ¼BUeQ(s,a)/Î²logÏ€(a|s)o
11:end forWhile the Q-weighted BC objective is
theoretically equivalent to the advantage-
weighted BC objective in terms of the op-
timal policy it recovers, it provides a sim-
pler and more practical formulation. This
simplification can lead to more stable and
accurate optimization in practice. Our
experimental results further demonstrate
that the Q-weighted formulation consis-
tently yields significantly better training
outcomes compared to the advantage-
weighted BC baseline. Bringing all com-
ponents together, we present our CON-
TRADICE algorithm in Algorithm 1.
6 Experiments
In this section, we conduct extensive experiments to evaluate our method, focusing on the following
key questions: (Q1) Can ContraDICE effectively leverage both labeled good and bad data to outper-
form existing baselines? (Q2) How does the size of the bad dataset BBaffect the performance of
ContraDICE? (Q3) ContraDICE relies on an important parameter Î±to balance the objectives for
good and bad dataâ€”how does this parameter affect overall performance? Moreover, we also provide
some additional experiments in the Appendix.
6.1 Experiment setting
Environments and Dataset Generation. We evaluate our method in the context of learning from the
good dataset BGand avoid the bad dataset BBwith a support from an additional unlabeled dataset
BMIX. The use of such unlabeled data is common in offline imitation learning from mixed-quality
demonstrations. Our experiments span four MuJoCo locomotion tasks: CHEETAH ,ANT,HOPPER ,
WALKER , as well as four hand manipulation tasks from Adroit: PEN,HAMMER ,DOOR ,RELOCATE ,
and one task from FrankaKitchen: KITCHEN â€”all sourced from the official D4RL benchmark [ 6]. For
each MuJoCo task from D4RL, we have three types of datasets: RANDOM ,MEDIUM , and EXPERT .
The good dataset BGis constructed using a single trajectory from the EXPERT dataset. The bad dataset
BBconsists of 10 trajectories selected from either the RANDOM orMEDIUM dataset. To construct the
unlabeled dataset BMIX, we combine the entire RANDOM orMEDIUM dataset (i.e., the same source
asBB) with 30 additional trajectories from the EXPERT dataset. This setup mirrors the challenging
7RANDOM +FEW-EXPERT and MEDIUM +FEW-EXPERT scenarios introduced in ReCOIL [ 35]. These
three datasetsâ€” BG,BB, andBMIXâ€”form the foundation of our training pipeline. We use the
same dataset construction strategy for Adroit and FrankaKitchen tasks, yielding 18 distinct dataset
combinations. Please refer to the Appendix for detailed descriptions of all dataset combinations.
Baselines. We compare our method against several baselines. First, we evaluate two naive Behavioral
Cloning approaches: one that learns directly from the large unlabeled dataset BMIX(BC-MIX), and one
that learns solely from the good dataset BG(BC-G). Next, we include comparisons with state-of-the-
art methods designed to leverage both expert (or good) data BGand unlabeled data BMIX, including
SMODICE [ 27], ILID [ 41], and ReCOIL [ 35]. We exclude DWBC [ 40] from this experiment since
both DWBC and ILID use discriminator-based objectives, and ILID has been shown to outperform
DWBC. In addition, based on our proposed objective in (4), we include a variant of our method that
only learns from BGandBMIX(i.e.,Î±= 0), called as ContraDICE-G. For methods that incorporate
support from bad data BB, we evaluate our approach against SafeDICE [ 17]. Given the limited
number of existing baselines that effectively utilize poor-quality data in offline imitation learning, we
also propose a simple adaptation of DWBC, which is called as DWBC-GB to jointly learn from BG,
BB, andBMIX. Detailed implementation of these baselines are provided in the Appendix.
Evaluation Metrics. We evaluate all methods using five training seeds. For each seed, we collect the
results from the last 10 evaluations (each evaluation consist 10 different environment seeds), then
aggregate all evaluations across seeds to compute the mean and standard deviation, which reflect
the converged performance of each method. Across all experiments, we report the normalized score
commonly used in D4RL tasks
Normalized Score =Scoreâˆ’Random Score
Expert Score âˆ’Random Score
. This normalization
provides a consistent performance measure across different environments.
Reproducibility. We provide detailed hyperparameters and network architectures for each task in
the Appendix. To ensure reproducibility and comparison, the source code is publicly available at:
https://github.com/hmhuy0/ContraDICE .
6.2 Main Comparison
Task unlabeled BMIX learning from BGandBMIXonly learning with BB
BC-MIX BC-G SMODICE ILID ReCOIL ContraDICE-G SafeDICE DWBC-GB ContraDICE Expert
CHEETAHRANDOM +EXPERT 2.3Â±0.0âˆ’0.6Â±0.7 4.6Â±2.7 21.1Â±7.6 2.0Â±0.6 84.4Â±5.3 âˆ’0.0Â±0.0 2.8Â±1.1 86.7Â±5.0 90.6
MEDIUM +EXPERT 42.5Â±0.5âˆ’0.6Â±0.7 42.4Â±3.5 40.3Â±15.642.5Â±0.6 48.6Â±4.4 37.7Â±0.3 5.6Â±4.3 77.6Â±8.1 90.6
ANTRANDOM +EXPERT 30.9Â±0.1âˆ’7.2Â±10.34.6Â±21.6 71.8Â±19.456.2Â±11.2 100.6Â±22.1 âˆ’2.6Â±0.0 6.5Â±7.5 112.7Â±12.9 117.5
MEDIUM +EXPERT 91.2Â±1.9âˆ’7.2Â±10.388.5Â±9.3 39.6Â±25.7100.8Â±9.0 102.4Â±7.8 88.1Â±0.9âˆ’4.3Â±5.3 107.4Â±11.0 117.5
HOPPERRANDOM +EXPERT 4.9Â±0.2 17.9Â±6.1 56.4Â±20.6 81.6Â±32.081.0Â±32.8 79.4Â±33.1 41.1Â±3.1 40.8Â±21.3 93.6Â±20.5 109.6
MEDIUM +EXPERT 52.2Â±1.3 17.9Â±6.1 53.0Â±3.7 87.9Â±11.946.1Â±18.5 70.6Â±17.9 55.8Â±3.7 21.6Â±8.9 103.7Â±16.3 109.6
WALKERRANDOM +EXPERT 1.5Â±0.1 3.8Â±3.3 106.6Â±1.5 100.1Â±9.829.8Â±33.4 97.5Â±24.0 23.0Â±1.8 17.4Â±16.7 107.4Â±3.7 107.7
MEDIUM +EXPERT 70.8Â±0.7 3.8Â±3.3 6.0Â±5.0 89.7Â±23.772.1Â±12.1 99.8Â±15.5 60.2Â±2.9 25.6Â±16.6 108.2Â±0.9 107.7
PENCLONED +EXPERT 56.0Â±1.1 8.8Â±3.1 10.9Â±14.6 1.9Â±4.7 79.2Â±21.4 66.3Â±21.5 19.9Â±4.6 9.5Â±8.8 96.4Â±19.4 107.0
HUMAN +EXPERT 18.3Â±1.4 8.8Â±3.1 âˆ’2.5Â±0.5 5.1Â±4.8 99.9Â±18.9 95.5Â±19.7 21.8Â±5.7 6.5Â±5.3 101.5Â±18.7 107.0
HAMMERCLONED +EXPERT 0.4Â±0.8 1.4Â±0.7 0.8Â±0.9 0.4Â±1.3 3.4Â±4.6 66.5Â±26.3 0.0Â±0.2 2.8Â±5.6 74.3Â±17.8 119.0
HUMAN +EXPERT 12.8Â±7.3 1.4Â±0.7 1.9Â±4.6 1.2Â±3.1 113.2Â±12.4113.2Â±16.1 0.6Â±0.8 3.4Â±4.2 120.0Â±8.3 119.0
DOORCLONED +EXPERT 0.4Â±0.7âˆ’0.1Â±0.1âˆ’0.1Â±0.1âˆ’0.1Â±0.2 19.3Â±16.7 92.6Â±11.3 âˆ’0.0Â±0.0âˆ’0.1Â±0.1 102.4Â±3.8 105.3
HUMAN +EXPERT 4.0Â±2.6âˆ’0.1Â±0.1âˆ’0.1Â±0.7 0.2Â±1.6 100.3Â±6.4 104.7Â±1.5 0.9Â±0.9 1.1Â±1.1 105.0Â±1.2 105.3
RELOCATECLONED +EXPERT âˆ’0.1Â±0.1âˆ’0.1Â±0.1 0.1Â±0.2 âˆ’0.1Â±0.1 1.4Â±2.4 34.5Â±13.9 âˆ’0.1Â±0.0âˆ’0.2Â±0.1 92.1Â±11.1 100.9
HUMAN +EXPERT 0.0Â±0.1âˆ’0.1Â±0.1âˆ’0.2Â±0.1âˆ’0.2Â±0.2 72.3Â±12.6 99.1Â±6.9 0.0Â±0.1âˆ’0.1Â±0.0 102.6Â±5.3 100.9
KITCHENPARTIAL +COMPLETE 45.5Â±1.9 2.5Â±5.0 5.5Â±8.2 27.3Â±5.4 48.8Â±8.9 45.8Â±14.8 2.8Â±1.1 19.4Â±4.6 53.1Â±13.1 75.0
MIXED +COMPLETE 42.1Â±1.1 2.2Â±3.8 3.1Â±5.8 13.3Â±3.1 50.6Â±3.8 20.3Â±14.1 1.5Â±1.9 6.7Â±4.4 48.9Â±16.4 75.0
Average 26.4 2.9 21.2 32.4 56.6 78.8 19.5 9.2 94.1
Table 1: Comparison with other baselines in MuJoCo, Adroit, and FrankaKitchen. The results are
normalized score in mean and standard deviation.
To answer Question (Q1) , we present a comprehensive comparison between our method and existing
baselines across 18 different datasets, as shown in Table 1. First, both BC-MIX and BC-G fail
to achieve satisfactory performance across tasks. When learning from the good dataset BGand
the unlabeled dataset BMIX, methods like SMODICE and ILID perform reasonably well on the
four MuJoCo locomotion tasks ( CHEETAH ,ANT,HOPPER ,WALKER ) but completely fail on the
five hand manipulation tasks. In contrast, ReCOIL and our method variant (ContraDICE-G) are
able to successfully learn in both locomotion and manipulation tasks, demonstrating more robust
generalization.
8In the setting that incorporates additional low-quality data BB, SafeDICE shows similar performance
to SMODICE and ILIDâ€”again failing on the manipulation tasks. Furthermore, DWBC-GB fails
to learn entirely, highlighting that a naive adaptation for leveraging poor-quality data can harm the
learning process. These results suggest that incorporating bad data BBintroduces new challenges,
and that effectively utilizing such data requires a carefully designed algorithm grounded in strong
theoretical principles. Overall, our method successfully leverages the bad dataset BBand consistently
outperforms all other baselines across both locomotion and manipulation tasks.
6.3 Effect of Number of Bad Demonstrations
Score
0 1 10 25 50 100
# bad trajectories255075100
CHEETAH
(RANDOM + EXPERT)
0 1 10 25 50 100
# bad trajectories255075100
HOPPER
(RANDOM + EXPERT)
0 1 10 25 50 100
# bad trajectories255075100
HAMMER
(CLONED + EXPERT)
0 1 10 25 50 100
# bad trajectories255075100
RELOCATE
(CLONED + EXPERT)
0 1 10 25 50 100
# bad trajectories255075100
KITCHEN
(PARTIAL + COMPLETE)
expert SafeDICE DWBC-GB ContraDICE
Figure 1: Effect of the size of the bad dataset BBon learning performance: The results are averaged
over five different training seeds and reported using normalized scores. As the number of bad trajec-
tories increases, our method demonstrates a strong ability to leverage this data. In contrast, baseline
methods such as SafeDICE and DWBC-GB struggle to make effective use of bad demonstrations.
To answer question (Q2) , we investigate the impact of the size of the undesirable (bad) dataset on
methods designed to learn from bad data. Specifically, we gradually increase the size of the bad
dataset BBand evaluate how the performance of each algorithm is affected. The experimental results
are presented in Figure 1. Overall, SafeDICE fails to effectively utilize the bad demonstrations, while
DWBC-GB is only able to learn in the HOPPER task. In contrast, our method demonstrates strong
scalability with respect to the size of the bad dataset, maintaining good performance even when
provided with as few as a single bad trajectory.
6.4 Sensitivity Analysis of Î±
0.0 0.1 0.2 0.3 0.4 0.5 0.6 0.7 0.8 0.9
Î±80100ScoreHOPPER (RANDOM + EXPERT)
0.0 0.1 0.2 0.3 0.4 0.5 0.6 0.7 0.8 0.9
Î±050100ScoreHAMMER (CLONED + EXPERT)
0.0 0.1 0.2 0.3 0.4 0.5 0.6 0.7 0.8 0.9
Î±4060ScoreKITCHEN (PARTIAL + COMPLETE)
Figure 2: Sensitivity analysis on the
trade-off parameter Î±.From our objective function (1), we introduce a hyper-
parameter 0â‰¤Î± < 1, which controls the weighting of
the bad data objectiveâ€”this relates to question (Q3) . To
evaluate the sensitivity of our method to Î±, we conduct
experiments by varying its value and observing the ef-
fect on final performance, as shown in Figure 2. While Î±
does have a noticeable impact, our method remains robust
across a broad range of values, with optimal performance
observed within this range. The specific Î±values used for
each task are provided in the Appendix.
7 Conclusion
We introduced a new offline imitation learning framework that leverages both expert and explicitly
undesirable demonstrations. By formulating the learning objective as the difference of KL divergences
over visitation distributions, we capture informative contrasts between good and bad behaviors. While
the resulting DC program is generally non-convex, we establish conditions under which it becomes
convexâ€”specifically, when expert data dominatesâ€”leading to a practical, stable, and non-adversarial
training procedure. Our unified approach to handling both expert and undesirable demonstrations
yields superior performance across a range of offline imitation learning benchmarks, setting a new
standard for learning from contrasting behaviors.
9Limitations and Future Work. While our method shows strong empirical performance, it is
currently limited to settings where Î±â‰¤1. Relaxing this constraint would make the learning objective
more challenging to optimize, but represents a promising direction for future research. Additionally,
we assume access to well-labeled expert and undesirable demonstrations, which may not hold in
practice. Developing robust methods that can learn effectively from noisy or weakly labeled data
would be a valuable extension of this work.
References
[1]Abbas Abdolmaleki, Bilal Piot, Bobak Shahriari, Jost Tobias Springenberg, Tim Hertweck,
Michael Bloesch, Rishabh Joshi, Thomas Lampe, Junhyuk Oh, Nicolas Heess, Jonas Buchli,
and Martin Riedmiller. Learning from negative feedback, or positive feedback or both. In The
Thirteenth International Conference on Learning Representations , 2025.
[2]Firas Al-Hafez, Davide Tateo, Oleg Arenz, Guoping Zhao, and Jan Peters. Ls-iq: Implicit
reward regularization for inverse reinforcement learning. In Eleventh International Conference
on Learning Representations (ICLR) , 2023.
[3]Oleg Arenz and Gerhard Neumann. Non-adversarial imitation learning and its connections to
adversarial methods. arXiv preprint arXiv:2008.03525 , 2020.
[4]Daniel Brown, Wonjoon Goo, Prabhat Nagarajan, and Scott Niekum. Extrapolating beyond sub-
optimal demonstrations via inverse reinforcement learning from observations. In International
conference on machine learning , pages 783â€“792. PMLR, 2019.
[5]Cheng Chi, Zhenjia Xu, Siyuan Feng, Eric Cousineau, Yilun Du, Benjamin Burchfiel, Russ
Tedrake, and Shuran Song. Diffusion policy: Visuomotor policy learning via action diffusion.
The International Journal of Robotics Research , page 02783649241273668, 2023.
[6]Justin Fu, Aviral Kumar, Ofir Nachum, George Tucker, and Sergey Levine. D4rl: Datasets for
deep data-driven reinforcement learning, 2020.
[7]Justin Fu, Katie Luo, and Sergey Levine. Learning robust rewards with adverserial inverse
reinforcement learning. In International Conference on Learning Representations , 2018.
[8]Divyansh Garg, Shuvam Chakraborty, Chris Cundy, Jiaming Song, and Stefano Ermon. Iq-learn:
Inverse soft-q learning for imitation. Advances in Neural Information Processing Systems ,
34:4028â€“4039, 2021.
[9]Divyansh Garg, Joey Hejna, Matthieu Geist, and Stefano Ermon. Extreme q-learning: Maxent
rl without entropy. In International Conference on Learning Representations (ICLR) , 2023.
[10] Ze Gong, Akshat Kumar, and Pradeep Varakantham. Offline safe reinforcement learning using
trajectory classification. In Proceedings of the AAAI Conference on Artificial Intelligence ,
volume 39, pages 16880â€“16887, 2025.
[11] Ian Goodfellow, Jean Pouget-Abadie, Mehdi Mirza, Bing Xu, David Warde-Farley, Sherjil
Ozair, Aaron Courville, and Yoshua Bengio. Generative adversarial nets. Advances in neural
information processing systems , 27, 2014.
[12] Tuomas Haarnoja, Aurick Zhou, Kristian Hartikainen, George Tucker, Sehoon Ha, Jie Tan,
Vikash Kumar, Henry Zhu, Abhishek Gupta, Pieter Abbeel, et al. Soft actor-critic algorithms
and applications. arXiv preprint arXiv:1812.05905 , 2018.
[13] Joey Hejna and Dorsa Sadigh. Inverse preference learning: Preference-based rl without a reward
function. Advances in Neural Information Processing Systems , 36, 2024.
[14] Jonathan Ho and Stefano Ermon. Generative adversarial imitation learning. Advances in neural
information processing systems , 29, 2016.
[15] Huy Hoang, Tien Mai, and Pradeep Varakantham. Imitate the good and avoid the bad: An
incremental approach to safe reinforcement learning. In Proceedings of the AAAI Conference
on Artificial Intelligence , volume 38, pages 12439â€“12447, 2024.
10[16] Huy Hoang, Tien Anh Mai, and Pradeep Varakantham. SPRINQL: Sub-optimal demonstrations
driven offline imitation learning. In The Thirty-eighth Annual Conference on Neural Information
Processing Systems , 2024.
[17] Youngsoo Jang, Geon-Hyeong Kim, Jongmin Lee, Sungryull Sohn, Byoungjip Kim, Honglak
Lee, and Moontae Lee. Safedice: offline safe imitation learning with non-preferred demonstra-
tions. Advances in Neural Information Processing Systems , 36, 2024.
[18] Yachen Kang, Diyuan Shi, Jinxin Liu, Li He, and Donglin Wang. Beyond reward: Offline
preference-guided policy optimization. In International Conference on Machine Learning ,
pages 15753â€“15768. PMLR, 2023.
[19] Changyeon Kim, Jongjin Park, Jinwoo Shin, Honglak Lee, Pieter Abbeel, and Kimin Lee.
Preference transformer: Modeling human preferences using transformers for rl. In The Eleventh
International Conference on Learning Representations , 2023.
[20] Geon-Hyeong Kim, Jongmin Lee, Youngsoo Jang, Hongseok Yang, and Kee-Eung Kim. Lobs-
dice: Offline learning from observation via stationary distribution correction estimation. Ad-
vances in Neural Information Processing Systems , 35:8252â€“8264, 2022.
[21] Geon-Hyeong Kim, Seokin Seo, Jongmin Lee, Wonseok Jeon, HyeongJoo Hwang, Hongseok
Yang, and Kee-Eung Kim. Demodice: Offline imitation learning with supplementary imperfect
demonstrations. In International Conference on Learning Representations , 2021.
[22] Ilya Kostrikov, Ofir Nachum, and Jonathan Tompson. Imitation learning via off-policy distribu-
tion matching. In International Conference on Learning Representations , 2020.
[23] Ilya Kostrikov, Ashvin Nair, and Sergey Levine. Offline reinforcement learning with implicit
q-learning. arXiv preprint arXiv:2110.06169 , 2021.
[24] Jongmin Lee, Wonseok Jeon, Byungjun Lee, Joelle Pineau, and Kee-Eung Kim. Optidice:
Offline policy optimization via stationary distribution correction estimation. In International
Conference on Machine Learning , pages 6120â€“6130. PMLR, 2021.
[25] Ziniu Li, Tian Xu, Zeyu Qin, Yang Yu, and Zhi-Quan Luo. Imitation learning from imperfection:
Theoretical justifications and algorithms. In Advances in Neural Information Processing Systems
37, 2023.
[26] Yuxiao Lu, Arunesh Sinha, and Pradeep Varakantham. Semantic loss guided data efficient
supervised fine tuning for safe responses in LLMs. In The Thirteenth International Conference
on Learning Representations , 2025.
[27] Yecheng Ma, Andrew Shen, Dinesh Jayaraman, and Osbert Bastani. Versatile offline imitation
from observations and examples via regularized state-occupancy matching. In International
Conference on Machine Learning , pages 14639â€“14663. PMLR, 2022.
[28] Liyuan Mao, Haoran Xu, Weinan Zhang, and Xianyuan Zhan. ODICE: Revealing the mystery of
distribution correction estimation via orthogonal-gradient update. In The Twelfth International
Conference on Learning Representations , 2024.
[29] V olodymyr Mnih, Koray Kavukcuoglu, David Silver, Andrei A Rusu, Joel Veness, Marc G
Bellemare, Alex Graves, Martin Riedmiller, Andreas K Fidjeland, Georg Ostrovski, et al.
Human-level control through deep reinforcement learning. nature , 518(7540):529â€“533, 2015.
[30] Vivek Myers, Erdem Biyik, Nima Anari, and Dorsa Sadigh. Learning multimodal rewards from
rankings. In Conference on robot learning , pages 342â€“352. PMLR, 2022.
[31] Ofir Nachum, Bo Dai, Ilya Kostrikov, Yinlam Chow, Lihong Li, and Dale Schuurmans. Al-
gaedice: Policy gradient from arbitrary experience. arXiv preprint arXiv:1912.02074 , 2019.
[32] Martin L Puterman. Markov decision processes: discrete stochastic dynamic programming .
John Wiley & Sons, 2014.
[33] Siddharth Reddy, Anca D Dragan, and Sergey Levine. Sqil: Imitation learning via reinforcement
learning with sparse rewards. arXiv preprint arXiv:1905.11108 , 2019.
11[34] StÃ©phane Ross, Geoffrey Gordon, and Drew Bagnell. A reduction of imitation learning and
structured prediction to no-regret online learning. In Proceedings of the fourteenth interna-
tional conference on artificial intelligence and statistics , pages 627â€“635. JMLR Workshop and
Conference Proceedings, 2011.
[35] Harshit Sikchi, Qinqing Zheng, Amy Zhang, and Scott Niekum. Dual rl: Unification and new
methods for reinforcement and imitation learning. In Proceedings of the 12th International
Conference on Learning Representations (ICLR) , 2024.
[36] Peter Sunehag, Guy Lever, Audrunas Gruslys, Wojciech Marian Czarnecki, Vinicius Zambaldi,
Max Jaderberg, Marc Lanctot, Nicolas Sonnerat, Joel Z Leibo, Karl Tuyls, et al. Value-
decomposition networks for cooperative multi-agent learning. arXiv preprint arXiv:1706.05296 ,
2017.
[37] Richard S. Sutton and Andrew G. Barto. Reinforcement Learning: An Introduction . The MIT
Press, second edition, 2018.
[38] Faraz Torabi, Garrett Warnell, and Peter Stone. Behavioral cloning from observation. arXiv
preprint arXiv:1805.01954 , 2018.
[39] Yueh-Hua Wu, Nontawat Charoenphakdee, Han Bao, V oot Tangkaratt, and Masashi Sugiyama.
Imitation learning from imperfect demonstration. In International Conference on Machine
Learning , pages 6818â€“6827. PMLR, 2019.
[40] Haoran Xu, Xianyuan Zhan, Honglei Yin, and Huiling Qin. Discriminator-weighted offline
imitation learning from suboptimal demonstrations. In Proceedings of the 39th International
Conference on Machine Learning , pages 24725â€“24742, 2022.
[41] Sheng Yue, Jiani Liu, Xingyuan Hua, Ju Ren, Sen Lin, Junshan Zhang, and Yaoxue Zhang.
How to leverage diverse demonstrations in offline imitation learning. In Forty-first International
Conference on Machine Learning , 2024.
[42] Songyuan Zhang, Zhangjie Cao, Dorsa Sadigh, and Yanan Sui. Confidence-aware imitation
learning from demonstrations with varying optimality. Advances in Neural Information Pro-
cessing Systems , 34:12340â€“12350, 2021.
[43] Tony Zhao, Vikash Kumar, Sergey Levine, and Chelsea Finn. Learning fine-grained bimanual
manipulation with low-cost hardware. Robotics: Science and Systems XIX , 2023.
[44] Henry Zhu, Justin Yu, Abhishek Gupta, Dhruv Shah, Kristian Hartikainen, Avi Singh, Vikash
Kumar, and Sergey Levine. The ingredients of real world robotic reinforcement learning. In
International Conference on Learning Representations , 2020.
12Appendix
A Missing Proofs
Proposition (4.1) :IfÎ±â‰¤1, then the objective function f(dÏ€) =DKL(dÏ€âˆ¥dG)âˆ’Î± D KL(dÏ€âˆ¥dB)
is convex in dÏ€.
Proof. We write the objective function as:
f(dÏ€) =X
(s,a)âˆ¼dÏ€logdÏ€(s, a)
dG(s, a)âˆ’Î±X
(s,a)âˆ¼dÏ€logdÏ€(s, a)
dB(s, a)
=X
s,a(1âˆ’Î±)dÏ€(s, a) logpÏ€(s, a) +dÏ€(s, a)(Î±dB(s, a)âˆ’dG(s, a)) (9)
We can see that the first term is convex in dÏ€since Î±â‰¤1anddÏ€(s, a) logdÏ€(s, a)is convex in dÏ€.
Moreover, the second term is linear in dÏ€. This implies that f(dÏ€)is convex in Ï€ifÎ±â‰¤1, as desired.
Proposition 4.2: The objective function in (2)can be written as: f(d, Ï€) = (1 âˆ’Î±)DKL(d||dU)âˆ’
E(s,a)âˆ¼d[Î¨(s, a)], where Î¨(s, a) = logdG(s,a)
dU(s,a)âˆ’Î±logdB(s,a)
dU(s,a).
Proof. We can expand the objective function as:
f(d, Ï€) =E(s,a)âˆ¼d
logd(s, a)
dG(s, a)
âˆ’Î±E(s,a)âˆ¼d
logd(s, a)
dB(s, a)
.
We can rewrite the objective using dUas an intermediate distribution:
f(d, Ï€) =E(s,a)âˆ¼d
logd(s, a)
dG(s, a)
âˆ’Î±E(s,a)âˆ¼d
logd(s, a)
dB(s, a)
=E(s,a)âˆ¼d
logd(s, a)
dU(s, a)+ logdU(s, a)
dG(s, a)
âˆ’Î±E(s,a)âˆ¼d
logd(s, a)
dU(s, a)+ logdU(s, a)
dB(s, a)
= (1âˆ’Î±)E(s,a)âˆ¼d
logd(s, a)
dU(s, a)
âˆ’E(s,a)âˆ¼d[Î¨(s, a)],
= (1âˆ’Î±)DKL(d||dU)âˆ’E(s,a)âˆ¼d[Î¨(s, a)]
where Î¨(s, a) = logdG(s,a)
dU(s,a)âˆ’Î±logdB(s,a)
dU(s,a).
Proposition 4.3: Let the surrogate objective be defined as:
eL(Q, Ï€) = (1 âˆ’Î³)Esâˆ¼p0
VÏ€
Q(s)
âˆ’EdU[Î´(s, a)TÏ€[Q](s, a)] + (1 âˆ’Î±)EdU[Î´(s, a)].(10)
where Î´(s, a) = exp
Î¨(s,a)
1âˆ’Î±
.TheneL(Q, Ï€)is a lower bound of L(Q, Ï€), with equality when
TÏ€[Q](s, a) = 0 for all (s, a).
Proof. We first write L(Q, Ï€)as:
L(Q, Ï€) = (1 âˆ’Î³)Esâˆ¼p0
VÏ€
Q(s)
+ (1âˆ’Î±)E(s,a)âˆ¼dU
expÎ¨(s, a)âˆ’ TÏ€[Q](s, a)
1âˆ’Î±
= (1âˆ’Î³)Esâˆ¼p0
VÏ€
Q(s)
+ (1âˆ’Î±)E(s,a)âˆ¼dU
expÎ¨(s, a)
1âˆ’Î±
expâˆ’TÏ€[Q](s, a)
1âˆ’Î±
= (1âˆ’Î³)Esâˆ¼p0
VÏ€
Q(s)
+ (1âˆ’Î±)E(s,a)âˆ¼dU
Î´(s, a) expâˆ’TÏ€[Q](s, a)
1âˆ’Î±
,
13where we define Î´(s, a) := exp
Î¨(s,a)
1âˆ’Î±
.
Now, we use the inequality etâ‰¥t+ 1(which follows from the convexity of etand is tight at t= 0),
to obtain:
expâˆ’TÏ€[Q](s, a)
1âˆ’Î±
â‰¥ âˆ’TÏ€[Q](s, a)
1âˆ’Î±+ 1.
Substituting this into the expression for L(Q, Ï€), we get:
L(Q, Ï€)â‰¥(1âˆ’Î³)Esâˆ¼p0
VÏ€
Q(s)
+(1âˆ’Î±)E(s,a)âˆ¼dU
Î´(s, a)
âˆ’TÏ€[Q](s, a)
1âˆ’Î±+ 1
=:eL(Q, Ï€).
Equality holds in the inequality etâ‰¥t+ 1when t= 0, which corresponds to TÏ€[Q](s, a) = 0 . That
is, the equality L(Q, Ï€) =eL(Q, Ï€)holds when the rewards represented by the Q-function are zero
everywhere. This completes the proof.
Proposition 4.4: The following properties hold:
(i)eL(Q, Ï€)is linear in Qand concave in Ï€. As a result, the maxâ€“min optimization can be equiv-
alently reformulated as a minâ€“max problem: max Ï€minQeL(Q, Ï€) = min Qmax Ï€eL(Q, Ï€).
(ii)The minâ€“max problem minQmax Ï€eL(Q, Ï€)reduces to the following non-adversarial prob-
lem:
min
Q
eL(Q) = (1 âˆ’Î³)Esâˆ¼p0[VQ(s)]âˆ’E(s,a)âˆ¼dU
expÎ¨(s, a)
1âˆ’Î±
T[Q](s, a)
,
where the soft value function VQ(s)is defined as: VQ(s) =
Î²log P
aÂµU(a|s) exp( Q(s, a)/Î²)
,and the soft Bellman residual operator is given by:
T[Q](s, a) =Q(s, a)âˆ’Î³VQ(s).Moreover eL(Q)is convex in Q.
Proof. We first write eL(Q, Ï€)as:
eL(Q, Ï€) = (1 âˆ’Î³)Esâˆ¼p0
VÏ€
Q(s)
âˆ’E(s,a)âˆ¼dU
Î´(s, a) 
Q(s, a)âˆ’Î³Esâ€²
VÏ€
Q(sâ€²)
+ (1âˆ’Î±)E(s,a)âˆ¼dU[Î´(s, a)],
where we recall that
VÏ€
Q(s) =Eaâˆ¼Ï€(Â·|s)
Q(s, a)âˆ’Î²logÏ€(a|s)
ÂµU(a|s)
.
Thus, we can observe that eL(Q, Ï€)is linear in Q.
Moreover, the function VÏ€
Q(s)is concave in Ï€, since it is composed of the expectation over a linear
function of Ï€(through Q(s, a)) and the negative entropy-regularized KL-divergence term, which is
convex in Ï€and thus its negative is concave. That is,
VÏ€
Q(s) =Eaâˆ¼Ï€(Â·|s)
Q(s, a)âˆ’Î²logÏ€(a|s)
ÂµU(a|s)
is concave in Ï€.
Furthermore, since Î´(s, a)>0, the coefficients associated with VÏ€
Q(s)ineL(Q, Ï€)are non-negative.
This implies that the entire function eL(Q, Ï€)is concave in Ï€.
Now, since eL(Q, Ï€)is concave in Ï€and linear in Q, we can apply the minimax theorem to swap the
order of the max and min:
max
Ï€min
QeL(Q, Ï€) = min
Qmax
Ï€eL(Q, Ï€).
This holds because the function eL(Q, Ï€)satisfies the standard conditions of the minimax theorem: it
is concave in Ï€, convex (in fact, linear) in Q, and the optimization domains are convex.
14Next, observe that in eL(Q, Ï€), the variable Ï€only appears through the term VÏ€
Q(s), and all coeffi-
cients multiplying VÏ€
Q(s)are non-negative. Therefore, maximizing eL(Q, Ï€)overÏ€is equivalent to
maximizing VÏ€
Q(s)for each state sindependently. That is,
max
Ï€eL(Q, Ï€)â‰¡max
Ï€X
sc(s)VÏ€
Q(s),
for some non-negative coefficients c(s)â‰¥0, which implies it suffices to solve max Ï€VÏ€
Q(s)pointwise.
Recall the definition:
VÏ€
Q(s) =Eaâˆ¼Ï€(Â·|s)
Q(s, a)âˆ’Î²logÏ€(a|s)
ÂµU(a|s)
.
The inner maximization over Ï€(Â· |s)is a standard entropy-regularized problem, and the optimal
policy has the closed-form solution:
Ï€âˆ—(a|s) =ÂµU(a|s) exp
Q(s,a)
Î²
P
aâ€²ÂµU(aâ€²|s) exp
Q(s,aâ€²)
Î².
This is a weighted softmax over Q(s, a)values, using the baseline distribution ÂµU(a|s)as the
reference. Substituting this back into VÏ€
Q(s)yields the closed-form maximized value:
max
Ï€VÏ€
Q(s) =Î²log X
aÂµU(a|s) expQ(s, a)
Î²!
.
Thus:
min
Qmax
Ï€eL(Q, Ï€) = min
QeL(Q)
where
eL(Q) = (1 âˆ’Î³)Esâˆ¼p0[VQ(s)]âˆ’E(s,a)âˆ¼dU
expÎ¨(s, a)
1âˆ’Î±
(Q(s, a)âˆ’Î³Esâ€²[VQ(sâ€²)])
,
and
VQ(s) =Î²logX
aÂµU(a|s) expQ(s, a)
Î²
.
We can now see that eL(Q)is convex in Q, due to the following reasons:
â€¢The function Q(s, a)7â†’logP
aÂµU(a|s) exp
Q(s,a)
Î²
is a softmax (log-sum-exp), which
is convex.
â€¢VQ(s), being a composition of a convex function with an affine transformation, is convex in
Q.
â€¢ Expectations over convex functions (e.g., Esâˆ¼p0[VQ(s)],Esâ€²[VQ(sâ€²)]) preserve convexity.
â€¢The remaining terms in eL(Q), such as Q(s, a), appear linearly and thus preserve convexity.
Hence, the overall objective eL(Q)is convex in Q, which completes the proof.
Proposition 5.1 The following Q-weighted behavior cloning (BC) objective yields the same optimal
policy as the original advantage-weighted BC formulation in (7):
max
Ï€X
(s,a)âˆ¼BUexp1
Î²Q(s, a)
logÏ€(a|s). (11)
15Proof. The Q-weighted BC objective can be written as:
max
Ï€X
(s,a)ÂµU(s, a) exp1
Î²Q(s, a)
logÏ€(a|s).
This represents a weighted maximum likelihood objective, where the weights are shaped by the
exponential of the Q-values. For each state s, the optimal solution Ï€âˆ—(a|s)is given by:
Ï€âˆ—(a|s) =ÂµU(s, a) exp
1
Î²Q(s, a)
P
aâ€²ÂµU(s, aâ€²) exp
1
Î²Q(s, aâ€²).
Moreover, we recall that:
VQ(s) =Î²log X
aâ€²ÂµU(s, aâ€²) exp1
Î²Q(s, aâ€²)!
,
which allows us to express the optimal policy in terms of the advantage Q(s, a)âˆ’VQ(s)as:
Ï€âˆ—(a|s) =ÂµU(s, a) exp1
Î²(Q(s, a)âˆ’VQ(s))
.
This is precisely the optimal policy corresponding to the advantage-weighted BC objective defined in
Equation (7). This completes the proof.
B A Note on ContraDICE under f-Divergence
We note that the convexity stated in Proposition 4.1 does not hold under arbitrary f-divergences, even
under the same assumptions. To illustrate this, consider the following objective defined using an
f-divergence:
F(dÏ€) =Df(dÏ€âˆ¥dG)âˆ’Î± Df(dÏ€âˆ¥dB),
which can be written as:
F(dÏ€) =X
(s,a)dG(s, a)fdÏ€(s, a)
dG(s, a)
âˆ’Î± dB(s, a)fdÏ€(s, a)
dB(s, a)
.
Observe that each term
dG(s, a)fdÏ€(s, a)
dG(s, a)
âˆ’Î± dB(s, a)fdÏ€(s, a)
dB(s, a)
is not necessarily convex for any Î± >0. Whether this expression is convex depends on the values of
dG(s, a)anddB(s, a). In particular, if dG(s, a) = 0 â€”i.e., the state-action pair (s, a)is never visited
by the expert policyâ€”then the term may become concave. Therefore, in general, the objective F(dÏ€)
defined under an f-divergence is not convex in dÏ€for arbitrary choices of Î±. Thus, the standard
Lagrangian duality cannot be applied. For this reason, the KL divergence appears to be an ideal
choice for our problem of learning from both expert and undesirable demonstrations.
16C Experiment Settings
C.1 Full Pseudo Code
The detailed implementation are provided in Algorithm 2.
Algorithm 2 ContraDICE: Offline Imitation Learning from Contrasting Behaviors (full)
Require: Good dataset BG, Bad dataset BB, unlabeled dataset BU
Require: Hyperparameters: Î±âˆˆ[0,1),Î²,Î³,NÂµ,N, target update rate Ï„, batch size B
1:Initialize networks: Qwq(s, a),Vwv(s),Ï€Î¸(a|s), classifiers cG
wG(s, a),cB
wB(s, a)
2:Initialize target Q-network: Qtargetâ†Qwq
3:
4:Step 1: Estimate occupancy ratios
5:fori= 1toNÂµdo
6: Sample batch {(sG
i)â€²}B
i=1âˆ¼ BG;{(sB
i)â€²}B
i=1âˆ¼ BB;{(sU
i)â€²}B
i=1âˆ¼ BU
7: Update cG
wGby maximizing the objective in Equation (5).
8: Update cB
wBby maximizing an analogous objective to Equation (5) for the bad dataset.
9:end for
10:
11:Step 2: Calculate Î¨function
12:Calculate Î¨(s, a) = log
cG
wG(sâ€²)
1âˆ’cGwG(sâ€²)
âˆ’Î±log
cB
wB(sâ€²)
1âˆ’cBwB(sâ€²)
.
13:
14:Step 3: Train Q, V , and Policy
15:fori= 1toNdo
16: Sample batch {(si, ai, sâ€²
i,Î¨i)}B
i=1âˆ¼ BU
17: Q-Update: Minimize the objective ËœL(Qwq|Vwv) +1
2(Qwq(si, ai)âˆ’Î³Vwv(sâ€²
i))2.
18: (reference: ËœL(Q|V)from Sec 5/ Eq (6))
19: V-Update: Minimize the Extreme-V objective:
min
wv1
BBX
i=1
expQtarget(si, ai)âˆ’Vwv(si)
Î²
âˆ’Qtarget(si, ai)âˆ’Vwv(si)
Î²âˆ’1
.
20: Policy Update: Maximize the policy by using Q-weighted Behavior Cloning.
21: (reference: Sec 5/ Eq (8))
22: Target Q-Update: Soft update: Qtargetâ†Ï„Qwq+ (1âˆ’Ï„)Qtarget
23:end for
24:
25:return Trained policy Ï€Î¸
17C.2 Dataset Construction
From the official D4RL dataset we use three different domains:
â€¢ MuJoCo Locomotion[ CHEETAH ,ANT,HOPPER ,WALKER ] with three types of dataset:
â€“EXPERT
â€“MEDIUM
â€“RANDOM
â€¢ Adroit [ PEN,HAMMER ,DOOR ,RELOCATE ] with three types of dataset:
â€“EXPERT
â€“HUMAN
â€“CLONED
â€¢ FrankaKitchen [ KITCHEN ] with three types of dataset:
â€“COMPLETE
â€“MIXED
â€“PARTIAL
Following the approach of [ 35], we also provide several combinations across all three domains,
as shown in Table 2. Notably, the unlabeled dataset BMIXis constructed by combining the entire
suboptimal dataset with the expert dataset, resulting in an overlap between BBandBMIX. Nevertheless,
this setup is practical: given an good dataset BGand an unlabeled dataset BMIX, users can randomly
sample trajectories and assign them to either BGorBBwithout the need for any additional external
data.
Task Unlabeled name BGBBBMIX
CHEETAHRANDOM +EXPERT 1EXPERT 10RANDOM Full RANDOM +30 EXPERT
MEDIUM +EXPERT 1EXPERT 10MEDIUM Full MEDIUM +30 EXPERT
ANTRANDOM +EXPERT 1EXPERT 10RANDOM Full RANDOM +30 EXPERT
MEDIUM +EXPERT 1EXPERT 10MEDIUM Full MEDIUM +30 EXPERT
HOPPERRANDOM +EXPERT 1EXPERT 10RANDOM Full RANDOM +30 EXPERT
MEDIUM +EXPERT 1EXPERT 10MEDIUM Full MEDIUM +30 EXPERT
WALKERRANDOM +EXPERT 1EXPERT 10RANDOM Full RANDOM +30 EXPERT
MEDIUM +EXPERT 1EXPERT 10MEDIUM Full MEDIUM +30 EXPERT
PENCLONED +EXPERT 1EXPERT 25CLONED Full CLONED +100 EXPERT
HUMAN +EXPERT 1EXPERT 25HUMAN Full HUMAN +100 EXPERT
HAMMERCLONED +EXPERT 1EXPERT 25CLONED Full CLONED +100 EXPERT
HUMAN +EXPERT 1EXPERT 25HUMAN Full HUMAN +100 EXPERT
DOORCLONED +EXPERT 1EXPERT 25CLONED Full CLONED +100 EXPERT
HUMAN +EXPERT 1EXPERT 25HUMAN Full HUMAN +100 EXPERT
RELOCATECLONED +EXPERT 1EXPERT 25CLONED Full CLONED +100 EXPERT
HUMAN +EXPERT 1EXPERT 25HUMAN Full HUMAN +100 EXPERT
KITCHENPARTIAL +COMPLETE 1COMPLETE 25PARTIAL Full PARTIAL +1COMPLETE
MIXED +COMPLETE 1COMPLETE 25MIXED Full MIXED +1COMPLETE
Table 2: Dataset Construction. The numbers in Table 2 indicate the number of trajectories drawn
from each corresponding dataset. For the KITCHEN task, we follow the setting of [ 35], where only a
single trajectory from the COMPLETE dataset is included in BMIX.
18C.3 Baselines Implementation
We compare our method against several established baselines. For methods with publicly available
code, we utilized their official implementations without algorithmic modifications.
C.3.1 Behavior Cloning (BC)
We employ the standard Behavior Cloning (BC) objective, which aims to minimize the negative
log-likelihood of the demonstrated actions under the learned policy:
min
Ï€âˆ’E(s,a)âˆ¼BlogÏ€(a|s), (12)
where Bdenotes the dataset of state-action pairs. Specifically, Bcorresponds to BMIXin the case of
BC-MIX, or BGfor BC-G.
C.3.2 Other Baselines with Official Implementations
For the following baselines, we used their official, unmodified implementations:
â€¢SMODICE [27]: Applied to both the good dataset ( BG) and the mixed dataset ( BMIX). The
official code is available at [GitHub].
â€¢ILID [41]: Applied to BGandBMIX. The official code is available at [GitHub].
â€¢ReCOIL [35]: Applied to BGandBMIX. The official code is available at [GitHub].
â€¢SafeDICE [17]: Applied to the bad dataset ( BB) and the mixed dataset ( BMIX). The official
code is available at [GitHub].
C.3.3 DWBC-GB
DWBC-GB is our adaptation of DWBC [ 40] (original official implementation: [GitHub]). While the
original DWBC is designed for scenarios involving BGandBMIX, our modified version, DWBC-GB,
is extended to handle all three dataset types: BG,BB, andBMIX.
This adaptation involves training two discriminators: cGfor good data and cBfor bad data. Their
respective loss functions are:
LcG=Î·E(s,a)âˆ¼BG[âˆ’logcG(s, a,logÏ€(a|s))]
+E(s,a)âˆ¼BMIX[âˆ’log(1âˆ’cG(s, a,logÏ€(a|s)))]
âˆ’Î·E(s,a)âˆ¼BG[âˆ’log(1âˆ’cG(s, a,logÏ€(a|s)))], (13)
LcB=Î·E(s,a)âˆ¼BB[âˆ’logcB(s, a,logÏ€(a|s))]
+E(s,a)âˆ¼BMIX[âˆ’log(1âˆ’cB(s, a,logÏ€(a|s)))]
âˆ’Î·E(s,a)âˆ¼BB[âˆ’log(1âˆ’cB(s, a,logÏ€(a|s)))]. (14)
The policy Ï€is then learned by minimizing the objective:
min
Ï€ 
E(s,a)âˆ¼BG
âˆ’logÏ€(a|s)Â·
Î±âˆ’Î·
c(s, a) (1âˆ’c(s, a))
+E(s,a)âˆ¼BMIX
âˆ’logÏ€(a|s)Â·1
1âˆ’c(s, a)!
, (15)
where c(s, a) =cG(s, a)âˆ’cB(s, a). (Note: Î·andÎ±are hyperparameters.)
19C.4 Hyper Parameters
Our method features two primary hyperparameters: Î±(weighting for balancing positive and negative
samples) and Î²(Extreme-V update). Sections 6.4, D.6, and D.8 present ablation studies detailing the
sensitivity to these parameters.
Specific parameters for all tasks are provided in Table 3 below:
Task Unlabeled name Î± Î²
CHEETAHRANDOM +EXPERT 0.6 20.0
MEDIUM +EXPERT 0.6 15.0
ANTRANDOM +EXPERT 0.6 15.0
MEDIUM +EXPERT 0.6 15.0
HOPPERRANDOM +EXPERT 0.4 30.0
MEDIUM +EXPERT 0.4 30.0
WALKERRANDOM +EXPERT 0.6 20.0
MEDIUM +EXPERT 0.6 20.0
PENCLONED +EXPERT 0.4 15.0
HUMAN +EXPERT 0.4 10.0
HAMMERCLONED +EXPERT 0.2 10.0
HUMAN +EXPERT 0.6 20.0
DOORCLONED +EXPERT 0.4 15.0
HUMAN +EXPERT 0.4 10.0
RELOCATECLONED +EXPERT 0.4 30.0
HUMAN +EXPERT 0.8 3.0
KITCHENPARTIAL +COMPLETE 0.3 10.0
MIXED +COMPLETE 0.3 30.0
Table 3: Hyper parameters.
Beyond these, all other hyperparameters are consistently applied across all benchmarks and settings.
The policy, Q-function, V-function, and discriminator all utilize a 2-layer feedforward neural network
architecture with 256 hidden units and ReLU activation functions. For the policy, Tanh Gaussian
outputs are used. The Adam optimizer is configured with a weight decay of 1Ã—10âˆ’3, all learning
rates are set to 3Ã—10âˆ’4, mini batch size is 1024, and a soft critic update parameter Ï„= 0.005is
used. These hyperparameters are summarized in Table 4:
Hyperparameter Value
Network Architecture2-layer Neural Network(Policy, Q-func, V-func, Discriminator)
Hidden Units per Layer 256
Batch size 1024
Activation Function (Hidden Layers) ReLU
Policy Output Activation Tanh Gaussian
Optimizer Adam
Learning Rate (all networks) 3Ã—10âˆ’4
Weight Decay (Adam) 1Ã—10âˆ’3
Soft Critic Update Rate ( Ï„) 0.005
Table 4: Consistent hyperparameters used across all benchmarks and settings.
C.5 Computational Resource
Our experiments were conducted using a pool of 12 NVIDIA GPUs, including L40, A5000, and
RTX 3090 models. For each experimental configuration, five training seeds were executed in
parallel, sharing a single GPU, eight CPU cores, and 64 GB of RAM. Under these shared conditions,
completing 1 million training steps across all five seeds took approximately 30 minutes. The software
environment was based on JAX version 0.4.28 (with CUDA 12 support), running on CUDA version
12.3.2 and cuDNN version 8.9.7.29.
20D Additional Experiments
D.1 Impact of the Size of the Bad Dataset: Full Details
To support the experiment in Section 6.3, we present the complete results for all MuJoCo Locomotion
and Adroit manipulation tasks. In particular, we progressively increase the size of the suboptimal
dataset BBand evaluate the impact on each algorithmâ€™s performance. The results, shown in Figure 3,
demonstrate that ContraDICE consistently outperforms all other baselines across all tasks, effectively
leveraging the bad data to achieve superior performance. Notably, the results indicate that with only a
single good trajectory in BG, increasing the number of bad trajectories in BBto just 10 is sufficient
for ContraDICE to achieve its highest performance across all tasks.
expert SafeDICE DWBC-GB ContraDICEScore
0 1 10 25 50 100
# bad trajectories255075100
CHEETAH
(RANDOM + EXPERT)
0 1 10 25 50 100
# bad trajectories255075100
ANT
(RANDOM + EXPERT)
0 1 10 25 50 100
# bad trajectories255075100
HOPPER
(RANDOM + EXPERT)
0 1 10 25 50 100
# bad trajectories255075100
WALKER
(RANDOM + EXPERT) Score
0 1 10 25 50 100
# bad trajectories255075100
CHEETAH
(MEDIUM + EXPERT)
0 1 10 25 50 100
# bad trajectories255075100
ANT
(MEDIUM + EXPERT)
0 1 10 25 50 100
# bad trajectories255075100
HOPPER
(MEDIUM + EXPERT)
0 1 10 25 50 100
# bad trajectories255075100
WALKER
(MEDIUM + EXPERT) Score
0 1 10 25 50 100
# bad trajectories255075100
PEN
(CLONED + EXPERT)
0 1 10 25 50 100
# bad trajectories255075100
HAMMER
(CLONED + EXPERT)
0 1 10 25 50 100
# bad trajectories255075100
DOOR
(CLONED + EXPERT)
0 1 10 25 50 100
# bad trajectories255075100
RELOCATE
(CLONED + EXPERT) Score
0 1 10 25 50 100
# bad trajectories255075100
PEN
(HUMAN + EXPERT)
0 1 10 25 50 100
# bad trajectories255075100
HAMMER
(HUMAN + EXPERT)
0 1 10 25 50 100
# bad trajectories255075100
DOOR
(HUMAN + EXPERT)
0 1 10 25 50 100
# bad trajectories255075100
RELOCATE
(HUMAN + EXPERT)
Figure 3: Full bad dataset size effect. SafeDICE and DWBC-GB do not have version that learn from
0 bad trajectory, we assign result 0.0 for them.
21D.2 Impact of the Number of Expert Demonstrations in BG
In this section, we investigate how many expert trajectories in the good dataset BGare sufficient to
achieve optimal performance. To this end, the quantity of expert trajectories in BGwas incrementally
increased through the set 1,3,5,10,25, while the composition of the unlabeled dataset ( BMIX) remained
fixed, as specified in Table 1. The detailed results are presented in Figure 4 and 5.
ILID performs well on the Mujoco locomotion tasks ( CHEETAH ,ANT,HOPPER ,WALKER ), but
struggles in 3 out of 4 Adroit tasks ( HAMMER ,DOOR ,RELOCATE ). This indicates that ILID requires
a sufficient number of expert trajectories to achieve stable expert performance, which is not met in the
more complex Adroit tasks. In contrast, ReCOIL appears unable to effectively leverage the good data,
as its performance does not improve significantly with more expert trajectories. Overall, ContraDICE
demonstrates consistently strong performance, requiring only 3 to 5 expert trajectories to achieve
near-optimal results in all tasks.
**Discussion on the Use Cases of ILID and ContraDICE: ** Through this experiment, we observe
that in the Mujoco tasks, ILID can outperform ContraDICE-G when the size of the good dataset is
sufficiently large. This highlights a limitation of ContraDICE, where the policy extraction objective is
defined as max Ï€nP
(s,a)âˆ¼BUexp(1
Î²Q(s, a)) log Ï€(a|s)o
. This objective uses data from the union
dataset BU, which may assign high weights to poor-quality transitions, potentially harming training.
In contrast, ILID only retains transitions that are connected to good data and explicitly discards
irrelevant or undesirable transitions (refer to the implementation details of ILID for more information).
This targeted filtering strategy enables ILID to avoid the negative effects of poor transitions and scale
more effectively with increasing amounts of good data.
These observations suggest a potential direction for improving ContraDICE by incorporating similar
data filtering mechanisms. Specifically, enhancing ContraDICE to better isolate high-quality transi-
tions could help it perform competitively with ILID in scenarios where the good dataset is large. We
leave this exploration for future work, as it requires a careful study of how to construct an optimal
dataset using Q-based methods.
In summary, ILID is a strong approach that scales well with the quality and size of the expert dataset.
Practitioners may prefer discriminator-based methods like ILID when sufficient high-quality expert
data is available, while ContraDICE remains a robust choice in settings where such data is limited
and scalalbe with bad dataset.Score
1 3 5 10 25
# Expert trajectories255075100
CHEETAH
(RANDOM + EXPERT)
1 3 5 10 25
# Expert trajectories255075100
ANT
(RANDOM + EXPERT)
1 3 5 10 25
# Expert trajectories255075100
HOPPER
(RANDOM + EXPERT)
1 3 5 10 25
# Expert trajectories255075100
WALKER
(RANDOM + EXPERT) Score
1 3 5 10 25
# Expert trajectories255075100
CHEETAH
(MEDIUM + EXPERT)
1 3 5 10 25
# Expert trajectories255075100
ANT
(MEDIUM + EXPERT)
1 3 5 10 25
# Expert trajectories255075100
HOPPER
(MEDIUM + EXPERT)
1 3 5 10 25
# Expert trajectories255075100
WALKER
(MEDIUM + EXPERT)
expert ReCOIL ILID ContraDICE-G
Figure 4: Different of good dataset size without impact from bad dataset in MuJoCo Locomotion
tasks.
22Score
1 3 5 10 25
# Expert trajectories255075100
PEN
(CLONED + EXPERT)
1 3 5 10 25
# Expert trajectories255075100
HAMMER
(CLONED + EXPERT)
1 3 5 10 25
# Expert trajectories255075100
DOOR
(CLONED + EXPERT)
1 3 5 10 25
# Expert trajectories255075100
RELOCATE
(CLONED + EXPERT) Score
1 3 5 10 25
# Expert trajectories255075100
PEN
(HUMAN + EXPERT)
1 3 5 10 25
# Expert trajectories255075100
HAMMER
(HUMAN + EXPERT)
1 3 5 10 25
# Expert trajectories255075100
DOOR
(HUMAN + EXPERT)
1 3 5 10 25
# Expert trajectories255075100
RELOCATE
(HUMAN + EXPERT)
expert ReCOIL ILID ContraDICE-G
Figure 5: Different of good dataset size without impact from bad dataset in Adroit Manipulation
tasks.
D.3 Discussion: How Many Bad Trajectories in BBAre Sufficient to Replace a Good
Trajectory in BGfor ContraDICE?
Based on the previous experiments:
â€¢Section D.1 addresses the question: How does the size of the bad dataset BBaffect the
performance of ContraDICE?
â€¢Section D.2 investigates an additional question: How does the size of the good dataset BG
affect the performance of ContraDICE?
From these experiments, we derive the following observations:
â€¢With only one good trajectory in BG, adding 10 bad trajectories in BBis sufficient for
ContraDICE to achieve its best performance.
â€¢Without any bad data BB, 3 to 5 good trajectories in BGare enough to reach peak perfor-
mance.
These results suggest that ContraDICE can efficiently utilize bad data to reduce the need for good
data, with an estimated ratio of 2 to 5 bad trajectories being roughly equivalent to one good trajectory
across the benchmarks studied in this paper.
23D.4 Comparison of Advantage-weighted BC and Q-weighted BC for the Policy Extraction
In this paper, we propose a novel policy extraction method called QW-BC (Objective (8)), in contrast
to prior approaches that rely on AW-BC (Objective (7)). In this section, we present a comparison
between QW-BC and AW-BC, as illustrated in Figure 6. Overall, QW-BC demonstrates superior
policy extraction performance, attributed to its stability derived from relying on a single network
estimation. In contrast, AW-BC often exhibits oscillations and instability, frequently assigning
inconsistent and overly high weights to bad transitions.Score
0.0 0.5 1.0
Train steps 1e6050100CHEETAH
(RANDOM + EXPERT)
expert
AW-BC
QW-BC
0.0 0.5 1.0
Train steps 1e6050100ANT
(RANDOM + EXPERT)
0.0 0.5 1.0
Train steps 1e6050100HOPPER
(RANDOM + EXPERT)
0.0 0.5 1.0
Train steps 1e6050100WALKER
(RANDOM + EXPERT) Score
0.0 0.5 1.0
Train steps 1e6050100CHEETAH
(MEDIUM + EXPERT)
0.0 0.5 1.0
Train steps 1e6050100ANT
(MEDIUM + EXPERT)
0.0 0.5 1.0
Train steps 1e6050100HOPPER
(MEDIUM + EXPERT)
0.0 0.5 1.0
Train steps 1e6050100WALKER
(MEDIUM + EXPERT) Score
0.0 0.5 1.0
Train steps 1e6050100PEN
(CLONED + EXPERT)
0.0 0.5 1.0
Train steps 1e6050100HAMMER
(CLONED + EXPERT)
0.0 0.5 1.0
Train steps 1e6050100DOOR
(CLONED + EXPERT)
0.0 0.5 1.0
Train steps 1e6050100RELOCATE
(CLONED + EXPERT) Score
0.0 0.5 1.0
Train steps 1e6050100PEN
(HUMAN + EXPERT)
0.0 0.5 1.0
Train steps 1e6050100HAMMER
(HUMAN + EXPERT)
0.0 0.5 1.0
Train steps 1e6050100DOOR
(HUMAN + EXPERT)
0.0 0.5 1.0
Train steps 1e6050100RELOCATE
(HUMAN + EXPERT)
Figure 6: AW-BC and QW-BC comparison.
D.5 Performance Across Varying Quality Levels of the Unlabeled Dataset BMIX
The performance of all methods is influenced by the quality of the unlabeled dataset BMIX. To evaluate
the robustness of our method under varying dataset quality, we conduct experiments with different
amounts of expert trajectories combined with the full set of undesirable trajectories in the unlabeled
dataset. We compare our approach against ILID and ReCOILâ€”which leverage BGandBMIXâ€”as
well as SafeDICE, which learns from BBandBMIX. The detailed results of this study are presented in
Figure 7.
In the Mujoco locomotion tasks, increasing the quality of the unlabeled dataset has minimal effect on
SafeDICE and ILID, and both methods continue to underperform on the Adroit hand manipulation
tasks regardless of the number of expert trajectories included. In contrast, ReCOIL shows improved
performance as the quality of the unlabeled dataset increases, successfully learning 4 out of 8
tasks across both locomotion and manipulation domains. Overall, our method achieves near-expert
24performance on 7 out of 8 tasks while requiring significantly lower-quality unlabeled datasets BMIX,
demonstrating its superior data efficiency and robustness.
Score
10 30 50 100 400
# expert in unlabeled dataset255075100CHEETAH
(RANDOM + EXPERT)
10 30 50 100 400
# expert in unlabeled dataset255075100HOPPER
(RANDOM + EXPERT)
10 50 100 200 400
# expert in unlabeled dataset255075100HAMMER
(CLONED + EXPERT)
10 50 100 200 400
# expert in unlabeled dataset255075100RELOCATE
(CLONED + EXPERT) Score
10 30 50 100 400
# expert in unlabeled dataset255075100CHEETAH
(MEDIUM + EXPERT)
10 30 50 100 400
# expert in unlabeled dataset255075100HOPPER
(MEDIUM + EXPERT)
10 50 100 200 400
# expert in unlabeled dataset255075100HAMMER
(HUMAN + EXPERT)
10 50 100 200 400
# expert in unlabeled dataset255075100RELOCATE
(HUMAN + EXPERT)
expert SafeDICE ILID ReCOIL ContraDICE
Figure 7: Effect of Unlabeled Dataset Quality on Performance: We evaluate the effect of increasing
the number of expert trajectories in the unlabeled dataset BMIX. The results are calculated from 5
different training seeds, reported in normalized score. Our method outperforms SafeDICE, ILID and
ReCOIL across both locomotion and manipulation tasks, achieving near-expert performance on most
environments even with a small number of expert demonstrations.
D.6 Adaptations and Experiments with Î± >1
From our objective function (1), we introduce a hyperparameter 0â‰¤Î± < 1, which controls the
weighting of the bad data objectiveâ€”this corresponds to question (Q3) . To evaluate the sensitivity
of our method to Î±, we conduct experiments by varying its value and observing its impact on final
performance. Specifically, we perform a full sweep over Î±âˆˆ {0,0.1,0.2, . . . , 0.9}to illustrate how
this key hyperparameter influences learning outcomes.
Interestingly, we observe that in some cases, settings with Î±â‰¥1yield favorable performance,
suggesting that avoiding bad data may, at times, be more critical than imitating good data. However,
directly applying Î±â‰¥1in our original formulation violates convexity conditions.
To address this, we propose a naive modification of Objective (6)that accommodates Î±â‰¥1while
preserving practical applicability. The revised objective is defined as:
eL(Q|V) = (1 âˆ’Î³)Esâˆ¼p0[V(s)]âˆ’E(s,a)âˆ¼dU[exp (Î¨( s, a)) (Q(s, a)âˆ’Î³Esâ€²[V(sâ€²)])],(16)
which enables empirical investigation into the high- Î±regime while sidestepping theoretical limitations.
The experiment results are provided in Figure 8. Overall, Î±â‰¥1does not provide good performance,
which raises the limitation of the naive adaptation.
250.0 0.1 0.2 0.3 0.4 0.5 0.6 0.7 0.8 0.9 1.0 2.0 3.0 4.0 5.0 6.0 7.0 8.0 9.010.0
Î±50100Score
HOPPER (RANDOM + EXPERT)
0.0 0.1 0.2 0.3 0.4 0.5 0.6 0.7 0.8 0.9 1.0 2.0 3.0 4.0 5.0 6.0 7.0 8.0 9.010.0
Î±0100Score
HAMMER (CLONED + EXPERT)
0.0 0.1 0.2 0.3 0.4 0.5 0.6 0.7 0.8 0.9 1.0 2.0 3.0 4.0 5.0 6.0 7.0 8.0 9.0 10.0
Î±255075Score
KITCHEN (PARTIAL + COMPLETE)Figure 8: Performance of large Î±â‰¥1.
D.7 Comparison Between L(Q, Ï€)and the Surrogate eL(Q, Ï€)
As shown in Proposition 4.3, the original objective L(Q|V)(Equation (3)) is transformed into a
modified version eL(Q|V)(Equation (6)). This experiment investigates the performance differences
between the two objectives.
To improve the stability of the original objective L(Q|V), we need to address the issue of exponential
terms producing extremely large values, which can lead to numerical instability. A practical approach
is to clip the input to the exponential function to a bounded range [minR ,maxR ], resulting in the
following formulation:
L(Q, Ï€) =(1âˆ’Î³)Esâˆ¼p0
VÏ€
Q(s)
+ (1âˆ’Î±)E(s,a)âˆ¼dU
expÎ¨(s, a)âˆ’ TÏ€[Q](s, a)
1âˆ’Î±
.clip(minR ,maxR )
,(17)
where minR =âˆ’7and maxR = 7in our experiments.
The results of this ablation study are presented in Figure 9, illustrating the performance impact of
this stability-enhancing modification. In general, the clipping technique effectively mitigates the
instability caused by the exponential term, successfully preventing NaN errors during training.
However, this modification also leads to a drop in performance and, in some tasks, causes the method
to fail to learn effectively.
26Score
0.00 0.25 0.50 0.75 1.00
Train stepsÃ—106050100CHEETAH
(RANDOM + EXPERT)
expert
L(Q|V)
/tildewideL(Q|V)
0.0 0.5 1.0
Train steps 1e6050100ANT
(RANDOM + EXPERT)
0.0 0.5 1.0
Train steps 1e6050100HOPPER
(RANDOM + EXPERT)
0.0 0.5 1.0
Train steps 1e6050100WALKER
(RANDOM + EXPERT) Score
0.0 0.5 1.0
Train steps 1e6050100CHEETAH
(MEDIUM + EXPERT)
0.0 0.5 1.0
Train steps 1e6050100ANT
(MEDIUM + EXPERT)
0.0 0.5 1.0
Train steps 1e6050100HOPPER
(MEDIUM + EXPERT)
0.0 0.5 1.0
Train steps 1e6050100WALKER
(MEDIUM + EXPERT) Score
0.0 0.5 1.0
Train steps 1e6050100PEN
(CLONED + EXPERT)
0.0 0.5 1.0
Train steps 1e6050100HAMMER
(CLONED + EXPERT)
0.0 0.5 1.0
Train steps 1e6050100DOOR
(CLONED + EXPERT)
0.0 0.5 1.0
Train steps 1e6050100RELOCATE
(CLONED + EXPERT) Score
0.0 0.5 1.0
Train steps 1e6050100PEN
(HUMAN + EXPERT)
0.0 0.5 1.0
Train steps 1e6050100HAMMER
(HUMAN + EXPERT)
0.0 0.5 1.0
Train steps 1e6050100DOOR
(HUMAN + EXPERT)
0.0 0.5 1.0
Train steps 1e6050100RELOCATE
(HUMAN + EXPERT)
Figure 9: Exponetial ablation study.
D.8 Sensitivity Analysis of Î²
In this section, we explore how different values of the Î²parameter affect performance. The experiment
results are provided in Table 5. The results show that while Î²significantly influences outcomes,
performance remains consistent over a wide range of Î²values, implying that minimal tuning effort is
needed for this hyperparameter.
Task unlabeled BMIX Î²value
1 3 5 10 15 20 30
CHEETAHRANDOM +EXPERT 2.25Â±0.02.25Â±0.02.25Â±0.0 2.24Â±0.0 83.2Â±5.3 85.8Â±2.1 84.3Â±1.4
MEDIUM +EXPERT 42.4Â±0.242.9Â±0.353.9Â±8.8 83.1Â±4.9 80.1Â±2.6 78.7Â±2.3 76.7Â±5.2
ANTRANDOM +EXPERT 39.5Â±7.369.3Â±6.560.9Â±28.7115.6Â±4.6118.0Â±2.1114.5Â±1.7116.0Â±2.1
MEDIUM +EXPERT 91.0Â±1.190.6Â±1.793.7Â±1.5 104.8Â±3.9106.5Â±2.4101.1Â±3.395.1Â±1.3
HOPPERRANDOM +EXPERT 4.7Â±0.4 5.2Â±0.9 7.2Â±1.3 7.9Â±1.9 20.4Â±9.7 67.4Â±7.9 94.4Â±6.3
MEDIUM +EXPERT 52.1Â±1.546.0Â±1.085.8Â±11.696.3Â±8.1 96.9Â±12.5 99.6Â±4.1 98.0Â±5.7
WALKERRANDOM +EXPERT 2.9Â±2.6 3.5Â±2.9 6.4Â±4.6 32.5Â±27.7105.7Â±4.5106.2Â±2.0107.5Â±1.1
MEDIUM +EXPERT 68.3Â±3.765.8Â±3.253.4Â±3.6 104.9Â±2.5108.1Â±0.1108.2Â±0.2 108.2Â±0.1
Table 5: Performance of ContraDICE in different Î²value in MuJoCo locomotion tasks.
27